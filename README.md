# Waterflow Shading Documentation

![Waterflow shading](/Documentation/Title.png "watershading")

## Features

- The ripples are simulated in two layers of Voronoi noise with parallel movement (one is the base and one is the highlight) , giving the final render a more dynamic and realistic look. 
- The vertex movement is simulated based on Perlin noise for a smoother animation. 
- The lightness of the surface texture and the intensity of the reflection are adjusted automatically to the angle of the directional light. (Adjust the slider in the demo scene to see the effect)
- The shader support cartoon style with certain setup of material properties. (See WaterFlowCartoon in the demo scene)

## Material Properties

### Base Color

| Base Color Properties | Description                                      |
|-----------------------|--------------------------------------------------|
| Color Tint            | Multiplicative mixing of color with main texture |
| Base Texture          | Static base texture of the water surface         |

### Dynamaic Ripple

| Ripple Properties               | Description                                                                                                                        |
|---------------------------------|------------------------------------------------------------------------------------------------------------------------------------|
| Reflection Noise            	  | The noise sample for simulating the dynamic reflection and highlight of the surface. Default is a tileable Voronoi noise.          |
| Reflection Noise Opacity    	  | Opacity of the base layer                                                                                                          |
| Highlight Opacity           	  | Opacity of the highlight layer                                                                                                     |
| Highlight Threshold         	  | Threshold for the highlight (using the reflection noise texture)                                                                   |
| Noise Min/Max               	  | Lower/Upper bound of the noise intensity, which is remapped with the smoothstep function                                           |

### Movement

| Distort Properties | Description    																      |
|--------------------|------------------------------------------------------------------------------------------------------------------------------------------------|
| Distort Amount     | The random distortion in the scrolling movement of the noise texture. This distortion is based on the sampling of the same noise texture.      |
| Scroll Speed       | The 2-dimensional rate of scrolling the noise texture.                                                                                         |
| Movement Noise     | The noise sample for moving vertex along the normal to simulate the wave. Default is a tileable Perlin noise.                                  |
| Wave Speed         | The speed of the vertex movement.                                                                                                              |
| Wave Height        | The height of the vertex movement.                                                                                                             |

## Implementation Details

- Based on the geometry of the water surface and the vertex animation, both the static (or real) normal (first image) and the dynamic (simulated) normal (second image) are calculated. These texture coordinates are brought into the fragment shader for calculating the static and dynamic lighting. The static lighting is applied additively to the base texture, while the dynamic lighting is applied multiplicatively to the animated ripple reflection and highlight.
![Static Normal](/Documentation/Geo01.png "static normal")
![Dynamic Normal](/Documentation/Geo02.png "static normal")
- Inspired by the reflective highlight effect of the water in a pond in NTU ADM, I generate the dynamic highlight by modulating the noise texture to produce small patches of cut-off area of whiteness. The highlight reacts to the angle of the directional light and is animated by the parallel movement of two noise textures.
![Water Reflection Real-world](/Documentation/Water01.png "water reflection real")
![Water Reflection Simulated](/Documentation/Water02.png "water simulation")
- The intensity of the reflection and highlight generated by the noise texture is remapped with the smoothstep function. Matching the value of Noise Min and Noise Max will produce the visual effect of cartoonish ripple animation. 
(First: Noise Min = 0, Noise Max = 1; Second: Noise Min = Noise Max = 0.5)
![Normal Ripple](/Documentation/Step01.png "normal ripple")
![Cartoon Ripple](/Documentation/Step02.png "cartoon ripple")
